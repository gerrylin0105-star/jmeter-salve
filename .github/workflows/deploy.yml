name: Deploy JMeter Slave

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      target_hosts:
        description: 'Target hosts (comma-separated, e.g., 223.27.43.100,223.27.43.101)'
        required: false
        default: 'all'

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host:
          - ip: 223.27.43.100
            username: ${{ secrets.HOST1_USERNAME }}
            password: ${{ secrets.HOST1_PASSWORD }}
          - ip: 223.27.43.101
            username: ${{ secrets.HOST2_USERNAME }}
            password: ${{ secrets.HOST2_PASSWORD }}
          - ip: 223.27.43.102
            username: ${{ secrets.HOST3_USERNAME }}
            password: ${{ secrets.HOST3_PASSWORD }}
          - ip: 223.27.43.103
            username: ${{ secrets.HOST4_USERNAME }}
            password: ${{ secrets.HOST4_PASSWORD }}
          - ip: 223.27.43.104
            username: ${{ secrets.HOST5_USERNAME }}
            password: ${{ secrets.HOST5_PASSWORD }}
          - ip: 223.27.43.105
            username: ${{ secrets.HOST6_USERNAME }}
            password: ${{ secrets.HOST6_PASSWORD }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to ${{ matrix.host.ip }}
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ matrix.host.ip }}
        username: ${{ matrix.host.username }}
        password: ${{ matrix.host.password }}
        port: 22
        script: |
          # 建立部署目錄
          mkdir -p ~/jmeter-slave-deploy
          cd ~/jmeter-slave-deploy

          # 清理舊檔案
          rm -rf *

          # 從 GitHub 下載最新代碼
          git clone https://github.com/gerrylin0105-star/jmeter-salve.git .

          # 賦予執行權限
          chmod +x deploy_jmeter_slave.sh online_deploy_slave.sh

          # 執行部署腳本
          sudo ./deploy_jmeter_slave.sh
